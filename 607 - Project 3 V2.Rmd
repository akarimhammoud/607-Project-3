---
title: "Project3 – Data Science Skills"
author: "Diego Correa, TJ Parker, and Karim Hammoud"
date: "`r Sys.Date()`"
output: ioslides_presentation
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, results = TRUE, fig.show = "show", message = TRUE)
```

**CUNY - SPS - 2020 Fall Term Data Acquisition and Management DATA 607**

**Project 3**

Create a short document, with the names of group members. 

You should briefly describe your collaboration tool(s) you’ll use as a group, including for communication, code sharing, and project documentation.

You should have identified your data sources, where the data can be found, and how to load it. 

And you should have created at least a logical model for your normalized database, and produced an Entity-Relationship (ER) diagram documenting your database design. 

This is a project for all the members of an assigned group to work on together, since being able to work effectively on a virtual team is a key “soft skill” for data scientists. 

Use data to answer the question, **“Which are the most valued data science skills?”**

Please note especially the requirement about making a presentation during the class meetup on the following Wednesday.

## Introduction

The collaboration tool we are using is Sharepoint and Github to share documents. We are also using Google Teams to meet every week to discuss the project progress. 

**The data source** we decided to use is [https://data.fivethirtyeight.com](https://data.fivethirtyeight.com) and we specifically chose the topic of the 2020 election forecasts as it is of topical interest not only to our group but also to the broader team. Per fivethirtyeight’s analysis, Joe Biden is forecast to win the election outlined in [this article.](https://projects.fivethirtyeight.com/2020-election-forecast/)

There are five csv files that we plan to read into our SQL database. These files are uploaded to Github with links below-

[economic_index](https://raw.githubusercontent.com/akarimhammoud/607-Project-3/master/Polling%20Datasets/economic_index.csv)

[presidential_probabilities2020](https://raw.githubusercontent.com/akarimhammoud/607-Project-3/master/Polling%20Datasets/presidential_ev_probabilities_2020.csv)

[presidential_national_toplines_2020](https://raw.githubusercontent.com/akarimhammoud/607-Project-3/master/Polling%20Datasets/presidential_national_toplines_2020.csv)

[presidential_scenario_analysis_2020](https://raw.githubusercontent.com/akarimhammoud/607-Project-3/master/Polling%20Datasets/presidential_scenario_analysis_2020.csv)

[presidential_state_toplines_2020](https://raw.githubusercontent.com/akarimhammoud/607-Project-3/master/Polling%20Datasets/presidential_state_toplines_2020.csv)

## Discription
The description of the tables and primary keys are identified below - 

**The presidential_ev_probabilities table** contains the forecasted chances of every possible Electoral College outcome. The unique identifier in this table is total_ev with modeldate, candidate_inc and candidate_chal as the foreign key. (This table is updated daily, so there is only one modeldate present.)

**The presidential_scenario_analysis table** contains the forecasted chances of various possible election outcome scenarios. The unique identifier for this table is the scenario_id and modeldate with foreign keys - candidate_inc and candidate_chal.

**The economic_index table** contains economic indicators that serve as inputs to the forecast. The unique identifers in this table are modeldate and indicator. The foreign keys are candidate_inc and candidate_chal. 
For more information on these indicators, see this [post](https://fivethirtyeight.com/features/measuring-the-effect-of-the-economy-on-elections/). The economic indexes were collected from the [Federal Reserve Bank Of St. Louis](https://fred.stlouisfed.org/series/DSPIC96) and the stock prices data from [Yahoo Finance](https://finance.yahoo.com/). This sheet contains the following additional columns:

**The presidential_national_toplines table** contains the final national topline on each day. The modeldate is the unique identifier for the presidential_national_toplines alongwith the popwin_inc and popwin_chal columns. These are the probabilities that the incumbent and the challenger will win the popular vote, respectively. These were chosen as unique identifiers because the sum of probabilities is 1 on any given day. In addition, candidate_inc and candidate_chal were selected as foreign keys referenced from the national_topline table.

**The presidential_state_toplines** contains the final state-level toplines on each day. The modeldate is the unique identifier for the presidential_national_toplines alongwith the winstate_inc and winstate_chal columns. These are the probabilities that the incumbent and the challenger will win the state, respectively. These were chosen as unique identifiers because the sum of probabilities is 1 on any given day. In addition, candidate_inc and candidate_chal were selected as foreign keys referenced from the national_topline table.

## Analysis - Introduction

**Which are the most valued data science skills?**

The answer is a mix of soft and hard/technical skills are most valued(Soft skills: Communication is very important as highlighted in both the R for data science text book and the Data science for business text.) Other soft skills would be interpersonal skills, collaboration (current collaboration on this project). Technical skills would be programming, data analysis, data visualization etc. 

Having a broad understanding of the big picture and ultimately the objective of any analysis or question behind a data science project is a critical skill as data science doesn’t operate in a vacuum and is used to ultimately support improved decision-making within a business domain. Also, having the big picture helps break down business problems into sub-tasks to which data science algorithms can be applied.  

We tackle the question above through several approaches - performing exploratory analysis to answer the specific question – Which economic indicator is the most relevant to election forecasts (S&P 500, PCE, Industrial Production, Nonfarm payrolls, CPI, Real disposable personal income)? (Correlation analysis, other metrics etc.?) We could make the question more precise as required in data science so that a specific data mining solution can be applied to answer the business problem. The topical question of interest for example is why there is a disconnect between the economy and the stock market. We could extend that to is the stock market performance a meaningful indicator of incumbent or challenger performance in the polls? This would be an example of a targeted question and we could use supervised segmentation methods such as classification or class probability estimation techniques to answer this? 

We also want to spend some portion of our energy and resources on exploring the data as competent data scientists to see what else the data can tell us. This would be unsupervised segmentation, so for example look at the state topline table and look at which states form natural groupings – Look at winstate_inc and winstate_chal for example, are there any natural groupings that exist for incumbent states and challenger states? 
After analyzing both questions, we will visualize the data using plots and stats analysis tools and provide a firm conclusion. 

## Libraries
```{r load-packages, message=FALSE}
library(tidyverse, quietly = TRUE)
library(lubridate, quietly = TRUE)
library(ggpubr)
library(usmap)
```

## Loading data
```{r cars}
library(tidyverse, quietly = TRUE)

#Presidential National Toplines
url1 <- 'https://projects.fivethirtyeight.com/2020-general-data/presidential_national_toplines_2020.csv'
#Presidential State Toplines
url2 <- 'https://projects.fivethirtyeight.com/2020-general-data/presidential_state_toplines_2020.csv'
#Presidential EV Probabilities
url3 <- 'https://projects.fivethirtyeight.com/2020-general-data/presidential_ev_probabilities_2020.csv'
#Presidential Scenario Analysis
url4 <- 'https://projects.fivethirtyeight.com/2020-general-data/presidential_scenario_analysis_2020.csv'
#Economic Index
url5 <- 'https://projects.fivethirtyeight.com/2020-general-data/economic_index.csv'

#Saving data into variables
dfPNT <- read.csv(file = url1)
dfPST <- read.csv(file = url2)
dfPEP <- read.csv(file = url3)
dfPSA <- read.csv(file = url4)
dfEI <- read.csv(file = url5)
```

## Observing & Cleaning 
```{r}
str(dfEI)
# str(dfPNT)
# str(dfPST)
# str(dfPEP)
# str(dfPSA)
```

When we look at the dataframes, we see the the modeldate and the timestamp fields are
stored as character types. Additionally, the timestamp field contains multplie whitespaces. 
Before dumping the data into the MySQL database, we need to clean up the fields.

As the same process needs to be done to each data frame, a function was created to 
address preform the necessary cleansing mentioned above. We do this with the help of
the lubridate package.

## Date formatting for all of the files
```{r}
datetime.this <- function(df){
  df$modeldate <- mdy(df$modeldate)
  df$timestamp <- str_replace_all(df$timestamp, ' {2}', ' ')
  x <- data.frame(str_split(df$timestamp, ':| ', n = 4, simplify = TRUE))
  x <- x %>%
    mutate(date = dmy(X4))
  x <- x %>%
    mutate(timestamp = as_datetime(paste(date, as.integer(X1), as.integer(X2), as.integer(X3),
                                         sep = ' ')))
  df$timestamp <- x$timestamp
  return(df)
}
dfEI <- datetime.this(dfEI)
dfPST <- datetime.this(dfPST)
dfPNT <- datetime.this(dfPNT)
dfPEP <- datetime.this(dfPEP)
dfPSA <- datetime.this(dfPSA)
str(dfEI)
```

## Connecting to database on Google Cloud
```{r}
#storing the data in google cloud database
library(RMySQL, quietly = TRUE)
con <- dbConnect(MySQL(),
                 user = 'root',
                 host = '35.225.135.85',
                 dbname = 'DATA607')

summary(con)
```

## Sorting the database
```{r message=FALSE}
dbWriteTable(con, 'Presidential_National_Toplines', dfPNT, row.names = FALSE, overwrite = TRUE)
dbWriteTable(con, 'Presidential_State_Toplines', dfPST, row.names = FALSE, overwrite = TRUE)
dbWriteTable(con, 'Presidential_EV_Probabilities', dfPEP, row.names = FALSE, overwrite = TRUE)
dbWriteTable(con, 'Presidential_Scenario_Analysis', dfPSA, row.names = FALSE, overwrite = TRUE)
dbWriteTable(con, 'Economic_Index', dfEI, row.names = FALSE, overwrite = TRUE)

dbListTables(con)
```

## Economic Index
```{r}
res <- dbGetQuery(con, 'select modeldate, category, current_zscore, projected_zscore
                  from Economic_Index;')
res$modeldate <- ymd(res$modeldate)

current <- ggplot(data = res) + 
  geom_smooth(mapping = aes(x = modeldate, y = current_zscore), color = 'brown') +
  geom_smooth(mapping = aes(x = modeldate, y = projected_zscore), color = 'green') +
  facet_wrap(~category) +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
current + scale_x_date(date_labels = '%m-%Y')
```

## Presidential EV Probabilities table

The Presidential EV Porbabilities table contains the forecasted chances of every possible Electoral College outcome. This table contains only one most recent day's electoral college simulations.

```{r}
str(dfPEP)
```

## Presidential Scenario Analysis

The Presidential Scenario Analysis contains the forecasted chances of various possible election outcome scenarios.

```{r}
str(dfPSA)
```

```{r}
res <- dbGetQuery(con, 'select modeldate, scenario_description, probability from Presidential_Scenario_Analysis;')

res$modeldate <- ymd(res$modeldate)

probScenario <- ggplot(data = res) +
  geom_line(mapping = aes(modeldate, y = probability, color = scenario_description)) +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

probScenario + scale_x_date(date_labels = '%m-%Y')
#not very pretty to look at
```

## Presidential National Toplines
contains the final national topline on each day.  
Chances to win electoral votes (Biden in blue, Trump in red)

```{r}
res <- dbGetQuery(con, 'select modeldate, ecwin_inc, ecwin_chal from 
                  Presidential_National_Toplines;')
res$modeldate <- ymd(res$modeldate)


probEWin <- ggplot(data = res) +
  geom_line(mapping = aes(x = modeldate, y = ecwin_inc), color = 'red') +
  geom_line(mapping = aes(x = modeldate, y = ecwin_chal), color = 'blue') +
  theme(axis.text.x =  element_text(angle = 70, hjust = 1))

probEWin + scale_x_date(date_labels = '%m-%Y')
```

## State Toplines

```{r}
str(dfPST)
```

```{r}
res1 <- dbGetQuery(con, 'select modeldate, state, state_turnout, winstate_inc,
                  winstate_chal, tipping from Presidential_State_Toplines;')

res2 <- dbGetQuery(con, 'select state, avg(state_turnout) AVG_Turnout from Presidential_State_Toplines 
                   group by state order by AVG_Turnout desc;')
head(res2)
```

### Trump projections per state

```{r warning = FALSE}
plot_a <- ggplot(dfPST, aes(x=reorder(state,desc(winstate_inc)), y=winstate_inc, fill = winstate_inc))+
  geom_bar(stat = 'identity')+
  xlab('State')+ylab('Projections')+
  theme(axis.text.x = element_text(angle=90, hjust=1, size=6))+
  scale_fill_gradient(low = 'white', high = 'red', name='Projections')


plot_b <- plot_usmap(data=dfPST, values= 'winstate_inc', color= 'gray')+
  scale_fill_gradient(low = 'white', high = 'red', name='Projections')+
  ggtitle('Trump Projections to Win in each State')+
  theme(legend.position = 'right')

#scale
ggarrange(plot_b,plot_a, nrow =2)
```

### Biden projections per state

```{r warning = FALSE}
plot_c <- ggplot(dfPST, aes(x=reorder(state,desc(winstate_chal)), y=winstate_chal, fill = winstate_chal))+
  geom_bar(stat = 'identity')+
  xlab('State')+ylab('Projections')+
  theme(axis.text.x = element_text(angle=90, hjust=1, size=6))+
  scale_fill_gradient(low = 'white', high = 'Blue', name='Projections')

plot_d <- plot_usmap(data=dfPST, values= 'winstate_chal', color= 'gray')+
  scale_fill_gradient(low = 'white', high = 'Blue', name='Projections')+
  ggtitle('Biden Projections to Win in each State')+
  theme(legend.position = 'right')

#scale
ggarrange(plot_d, plot_c, nrow =2)
```


## Conclusion
In the past 100 days, the polls shows simillar projects for both candidates, for Trump its around 45% - 47%, on the other side Biden has between 52% - 53%. Joe Biden is forecast to win the election outlined in [this article.](https://projects.fivethirtyeight.com/2020-election-forecast/)


